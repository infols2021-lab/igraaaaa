// assignments.js
import { supabase } from './supabase.js';

document.addEventListener('DOMContentLoaded', function() {
    console.log('Assignments page loaded');
    
    const materialHeader = document.getElementById('materialHeader');
    const assignmentsContainer = document.getElementById('assignmentsContainer');
    const backBtn = document.getElementById('backBtn');

    const urlParams = new URLSearchParams(window.location.search);
    const materialId = urlParams.get('material_id');

    console.log('Material ID from URL:', materialId);

    if (!materialId) {
        console.error('No material_id found in URL');
        showError('–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É.');
        return;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –∏ –∑–∞–¥–∞–Ω–∏—è
    loadMaterialAndAssignments(materialId);

    backBtn.addEventListener('click', function() {
        console.log('Back button clicked');
        window.location.href = 'materials.html';
    });

    async function loadMaterialAndAssignments(materialId) {
        console.log('Starting to load material and assignments for ID:', materialId);
        
        try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            showLoading();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª
            console.log('Fetching material from Supabase...');
            const { data: material, error: materialError } = await supabase
                .from('materials')
                .select('*')
                .eq('id', materialId)
                .single();

            if (materialError) {
                console.error('Supabase material error:', materialError);
                throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ${materialError.message}`);
            }

            if (!material) {
                console.error('Material not found for ID:', materialId);
                throw new Error('–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }

            console.log('Material loaded:', material);

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
            renderMaterialHeader(material);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞
            console.log('Fetching assignments from Supabase...');
            const { data: assignments, error: assignmentsError } = await supabase
                .from('assignments')
                .select('*')
                .eq('material_id', materialId)
                .order('created_at', { ascending: true });

            if (assignmentsError) {
                console.error('Supabase assignments error:', assignmentsError);
                throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π: ${assignmentsError.message}`);
            }

            console.log('Assignments loaded:', assignments);
            renderAssignments(assignments);

        } catch (error) {
            console.error('Error in loadMaterialAndAssignments:', error);
            showError(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è');
        }
    }

    function renderMaterialHeader(material) {
        console.log('Rendering material header:', material);
        
        const materialIcon = getMaterialIcon(material.title);
        let imageHtml = '';
        
        if (material.image_url) {
            imageHtml = `<img src="${material.image_url}" alt="${material.title}" 
                          onerror="this.style.display='none'; this.parentElement.innerHTML='${materialIcon}'">`;
        } else {
            imageHtml = materialIcon;
        }

        materialHeader.innerHTML = `
            <div class="material-play-header">
                <div class="material-preview-large">
                    ${imageHtml}
                </div>
                <div class="material-info-large">
                    <h2>${material.title}</h2>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</p>
                </div>
            </div>
        `;
    }

    function renderAssignments(assignments) {
        console.log('Rendering assignments:', assignments);
        
        if (!assignments || assignments.length === 0) {
            assignmentsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</h3>
                    <p>–î–ª—è —ç—Ç–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã –∑–∞–¥–∞–Ω–∏—è</p>
                    <button class="btn btn-primary" onclick="window.location.href = 'materials.html'">
                        <i class="fas fa-arrow-left"></i>
                        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
                    </button>
                </div>
            `;
            return;
        }

        assignmentsContainer.innerHTML = `
            <div class="assignments-grid">
                ${assignments.map(assignment => `
                    <div class="assignment-play-card" data-id="${assignment.id}">
                        <div class="assignment-play-header">
                            <h3>${assignment.title}</h3>
                            <span class="assignment-type-badge">${getAssignmentTypeLabel(assignment.question_type)}</span>
                        </div>
                        <div class="assignment-play-content">
                            <p>${assignment.description || '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –Ω–∞–≤—ã–∫–æ–≤'}</p>
                            <div class="assignment-play-meta">
                                <span><i class="fas fa-question-circle"></i> ${assignment.questions?.length || 0} –≤–æ–ø—Ä–æ—Å–æ–≤</span>
                                ${assignment.sound_letter ? `<span><i class="fas fa-volume-up"></i> –ó–≤—É–∫: ${assignment.sound_letter}</span>` : ''}
                            </div>
                        </div>
                        <div class="assignment-play-actions">
                            <button class="btn btn-primary start-assignment" data-id="${assignment.id}">
                                <i class="fas fa-play"></i>
                                –ù–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        document.querySelectorAll('.start-assignment').forEach(btn => {
            btn.addEventListener('click', function() {
                const assignmentId = this.getAttribute('data-id');
                console.log('Starting assignment:', assignmentId);
                window.location.href = `assignment-play.html?assignment_id=${assignmentId}`;
            });
        });
    }

    function showLoading() {
        materialHeader.innerHTML = `
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª...</p>
            </div>
        `;
        
        assignmentsContainer.innerHTML = `
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è...</p>
            </div>
        `;
    }

    function getMaterialIcon(title) {
        if (!title) return 'üìñ';
        
        const lowerTitle = title.toLowerCase();
        if (lowerTitle.includes('–º–∞—Ç–µ–º–∞—Ç–∏') || lowerTitle.includes('—Å—á–µ—Ç')) return 'üî¢';
        if (lowerTitle.includes('–±—É–∫–≤') || lowerTitle.includes('–∞–ª—Ñ–∞–≤–∏—Ç') || lowerTitle.includes('—Å–ª–æ–≤')) return 'üìö';
        if (lowerTitle.includes('–∑–∞–≥–∞–¥') || lowerTitle.includes('–≥–æ–ª–æ–≤–æ–ª–æ–º')) return 'üéØ';
        if (lowerTitle.includes('—Ä–∏—Å–æ–≤–∞–Ω') || lowerTitle.includes('—Ç–≤–æ—Ä—á–µ—Å—Ç–≤')) return 'üé®';
        if (lowerTitle.includes('–ø—Ä–∏—Ä–æ–¥') || lowerTitle.includes('–∂–∏–≤–æ—Ç–Ω')) return 'üêæ';
        return 'üìñ';
    }

    function getAssignmentTypeLabel(type) {
        const types = {
            'type1': '–í—ã–±–æ—Ä –∫–∞—Ä—Ç–∏–Ω–æ–∫ —Å–æ –∑–≤—É–∫–æ–º',
            'type2': '–°—Ö–µ–º–∞ "–Ω–∞—á–∞–ª–æ-—Å–µ—Ä–µ–¥–∏–Ω–∞-–∫–æ–Ω–µ—Ü"',
            'type3': '–î–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–≥–∏',
            'type4': '–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º'
        };
        return types[type] || type || '–ó–∞–¥–∞–Ω–∏–µ';
    }

    function showError(message) {
        console.error('Showing error:', message);
        
        materialHeader.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>–û—à–∏–±–∫–∞</h3>
            </div>
        `;
        
        assignmentsContainer.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                <p>${message}</p>
                <div class="error-actions">
                    <button class="btn btn-primary" onclick="window.location.href = 'materials.html'">
                        <i class="fas fa-arrow-left"></i>
                        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <i class="fas fa-redo"></i>
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            </div>
        `;
    }
});